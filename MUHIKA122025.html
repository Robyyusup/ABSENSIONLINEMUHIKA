<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Login Admin & Panel Absensi - SMK Muhammadiyah Campaka Purwakarta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Konfigurasi Tailwind CSS untuk gaya kustom (opsional, tapi baik untuk konsistensi)
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4CAF50', // Hijau
                        secondary: '#333',
                        background: '#1a1a1a',
                        card: '#2a2a2a',
                        text: '#e0e0e0',
                        light_green: '#8BC34A',
                        light_red: '#FFCDD2',
                        light_yellow: '#FFF9C4',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: theme('colors.background');
            color: theme('colors.text');
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Sejajarkan item ke atas untuk konten */
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            background-color: theme('colors.card');
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            box-sizing: border-box;
        }
        h2 {
            text-align: center;
            color: theme('colors.primary');
            margin-bottom: 30px;
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700; /* font-bold */
        }
        .input-group {
            margin-bottom: 20px;
        }
        input, button {
            padding: 12px 15px;
            margin: 5px 0;
            border: 1px solid theme('colors.secondary');
            border-radius: 8px;
            font-size: 1rem;
            color: theme('colors.text');
            background-color: theme('colors.secondary');
            width: 100%;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        input:focus {
            border-color: theme('colors.primary');
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.5); /* primary-500 dengan alpha */
        }
        button {
            background: theme('colors.primary');
            color: white;
            cursor: pointer;
            border: none;
            font-weight: 600;
            margin-top: 15px;
        }
        button:hover {
            background-color: theme('colors.light_green');
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .hidden {
            display: none;
        }
        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .tab-button {
            background-color: theme('colors.secondary');
            color: theme('colors.text');
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border: 1px solid theme('colors.secondary');
        }
        .tab-button:hover {
            background-color: #555;
            border-color: #555;
        }
        .tab-button.active {
            background-color: theme('colors.primary');
            border-color: theme('colors.primary');
            color: white;
            box-shadow: 0 3px 10px rgba(76, 175, 80, 0.4);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: theme('colors.background');
            color: theme('colors.text');
            border-radius: 8px;
            overflow: hidden; /* Untuk sudut bulat pada tabel */
        }
        th, td {
            padding: 12px;
            border: 1px solid #444; /* Border lebih gelap untuk kontras */
            text-align: left;
        }
        th {
            background-color: theme('colors.secondary');
            color: theme('colors.primary');
            font-weight: 700;
            cursor: pointer;
            position: relative;
        }
        th:hover {
            background-color: #555;
        }
        th.asc::after { content: ' \25B2'; /* Panah atas */ position: absolute; right: 8px; top: 50%; transform: translateY(-50%); }
        th.desc::after { content: ' \25BC'; /* Panah bawah */ position: absolute; right: 8px; top: 50%; transform: translateY(-50%); }

        tbody tr:nth-child(even) {
            background-color: #333; /* Background sedikit berbeda untuk baris genap */
        }
        tbody tr:hover {
            background-color: #444;
        }
        img {
            max-width: 80px;
            height: auto;
            border-radius: 8px;
            object-fit: cover;
            display: block; /* Memastikan tidak ada ruang ekstra di bawah gambar */
            margin: auto;
        }
        .error-message {
            color: #FF5252; /* Merah */
            margin-top: 10px;
            text-align: center;
            font-weight: 600;
        }
        .loading-message {
            text-align: center;
            padding: 20px;
            color: theme('colors.primary');
        }
        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-controls label {
            font-weight: 600;
        }
        .filter-controls select {
            background-color: theme('colors.secondary');
            border: 1px solid #555;
            padding: 8px;
            border-radius: 8px;
            color: theme('colors.text');
            width: auto;
            min-width: 150px;
        }
        .export-button {
            background-color: #007BFF; /* Biru */
            margin-top: 0;
        }
        .export-button:hover {
            background-color: #0056b3;
        }
        .indicator-red { background-color: theme('colors.light_red'); color: #C62828; font-weight: 600; }
        .indicator-yellow { background-color: theme('colors.light_yellow'); color: #FFD600; font-weight: 600; }
        .indicator-green { background-color: theme('colors.light_green'); color: #388E3C; font-weight: 600; }

        /* Penyesuaian responsif */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            h2 {
                font-size: 1.75rem; /* text-3xl */
            }
            .tab-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            .filter-controls select, .filter-controls button {
                width: 100%;
            }
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid #555;
                margin-bottom: 15px;
                border-radius: 8px;
                overflow: hidden;
            }
            td {
                border: none;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            td::before {
                content: attr(data-label);
                position: absolute;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: theme('colors.primary');
            }
        }
        /* Gaya peta Leaflet */
        #mapContainer {
            height: 500px; /* Sesuaikan tinggi sesuai kebutuhan */
            width: 100%;
            border-radius: 8px; /* Pastikan konsisten dengan styling Tailwind */
            overflow: hidden; /* Penting untuk Leaflet */
        }
    </style>
    <!-- Firebase SDK (v9 kompatibel dengan struktur yang Anda berikan) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <!-- SheetJS untuk ekspor Excel -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAo9TchX5tqF/fS5xI5/r6e5c5V5n2h0o1J0L0e0="
     crossorigin=""/>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-200X0/s5zI5/r6e5c5V5n2h0o1J0L0e0="
     crossorigin=""></script>
</head>
<body>
    <div class="container rounded-xl">
        <div id="login-area">
            <h2 class="text-primary">Login Admin</h2>
            <div class="input-group">
                <input type="email" id="email" placeholder="Email" class="rounded-lg">
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="Password" class="rounded-lg">
            </div>
            <button onclick="login()" class="rounded-lg">Login</button>
            <p id="login-error" class="error-message"></p>
        </div>

        <div id="admin-panel" class="hidden">
            <h2 class="text-primary text-center">PANEL ADMIN REKAP ABSENSI<br>SMK MUHAMMADIYAH CAMPAKA PURWAKARTA</h2>
            <p id="loggedInUserInfo" class="text-center text-lg mb-5"></p>
            <div class="flex justify-end mb-5">
                <button onclick="logout()" class="rounded-lg bg-red-600 hover:bg-red-700">Logout</button>
            </div>

            <div class="tab-buttons">
                <button class="tab-button active rounded-lg" data-tab="guru-absensi-section">Absensi Guru</button>
                <button class="tab-button rounded-lg" data-tab="siswa-absensi-section">Absensi Siswa</button>
                <button class="tab-button rounded-lg" data-tab="map-siswa-section">Peta Siswa</button>
                <button class="tab-button rounded-lg" data-tab="gallery-siswa-section">Galeri Siswa</button>
            </div>

            <!-- Absensi Guru Section -->
            <div id="guru-absensi-section" class="content-section">
                <h3 class="text-primary text-xl font-bold mb-4 border-b pb-2 border-gray-600">(GURU) - Rekap Absensi</h3>
                <div class="filter-controls">
                    <label for="filterGuruHari">Hari:</label>
                    <select id="filterGuruHari" class="rounded-lg">
                        <option value="all">Keseluruhan dalam seminggu</option>
                        <option value="1">Hari ke-1</option>
                        <option value="2">Hari ke-2</option>
                        <option value="3">Hari ke-3</option>
                        <option value="4">Hari ke-4</option>
                        <option value="5">Hari ke-5</option>
                        <option value="6">Hari ke-6</option>
                        <option value="7">Hari ke-7</option>
                    </select>
                    <button id="exportGuruExcel" class="export-button rounded-lg">Export ke Excel</button>
                </div>
                <div class="table-responsive">
                    <table id="guruAbsensiTable" class="rounded-lg">
                        <thead>
                            <tr>
                                <th data-column="namaGuru">Nama Guru</th>
                                <th data-column="pelajaran">Pelajaran</th>
                                <th data-column="kelas">Kelas</th>
                                <th data-column="lokasi" class="guru-col-specific">Lokasi</th>
                                <th data-column="foto" class="guru-col-specific">Foto</th>
                                <th data-column="materi" class="guru-col-specific">Materi</th>
                                <!-- Header harian dinamis akan dimasukkan di sini -->
                                <th data-column="indikator">Indikator</th>
                                <th data-column="totalMinggu">Keseluruhan (Minggu)</th>
                            </tr>
                        </thead>
                        <tbody id="guruAbsensiBody">
                            <tr><td colspan="9" class="loading-message">Memuat data absensi guru...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Absensi Siswa Section -->
            <div id="siswa-absensi-section" class="content-section hidden">
                <h3 class="text-primary text-xl font-bold mb-4 border-b pb-2 border-gray-600">(SISWA) - Rekap Absensi</h3>
                <div class="filter-controls">
                    <label for="filterSiswaHari">Hari:</label>
                    <select id="filterSiswaHari" class="rounded-lg">
                        <option value="all">Keseluruhan dalam seminggu</option>
                        <option value="1">Hari ke-1</option>
                        <option value="2">Hari ke-2</option>
                        <option value="3">Hari ke-3</option>
                        <option value="4">Hari ke-4</option>
                        <option value="5">Hari ke-5</option>
                        <option value="6">Hari ke-6</option>
                        <option value="7">Hari ke-7</option>
                    </select>
                    <button id="exportSiswaExcel" class="export-button rounded-lg">Export ke Excel</button>
                </div>
                <div class="table-responsive">
                    <table id="siswaAbsensiTable" class="rounded-lg">
                        <thead>
                            <tr>
                                <th data-column="namaSiswa">Nama</th>
                                <th data-column="pelajaran">Pelajaran</th>
                                <th data-column="kelas">Kelas</th>
                                <th data-column="lokasi" class="siswa-col-specific">Lokasi</th>
                                <th data-column="foto" class="siswa-col-specific">Foto</th>
                                <th data-column="namaGuru" class="siswa-col-specific">Nama Guru</th>
                                <!-- Header harian dinamis akan dimasukkan di sini -->
                                <th data-column="indikator">Indikator</th>
                                <th data-column="totalMinggu">Keseluruhan (Minggu)</th>
                            </tr>
                        </thead>
                        <tbody id="siswaAbsensiBody">
                            <tr><td colspan="9" class="loading-message">Memuat data absensi siswa...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Peta Siswa Section -->
            <div id="map-siswa-section" class="content-section hidden">
                <h3 class="text-primary text-xl font-bold mb-4 border-b pb-2 border-gray-600">Tampilan Peta Siswa</h3>
                <div id="mapContainer" class="w-full h-96 bg-gray-700 rounded-lg">
                    <!-- Peta akan diinisialisasi di sini -->
                    <p class="loading-message text-gray-400">Memuat peta...</p>
                </div>
            </div>

            <!-- Galeri Siswa Section -->
            <div id="gallery-siswa-section" class="content-section hidden">
                <h3 class="text-primary text-xl font-bold mb-4 border-b pb-2 border-gray-600">Galeri Siswa</h3>
                <div id="galleryContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <p class="col-span-full text-center text-gray-400">Gambar galeri siswa akan ditampilkan di sini.</p>
                    <!-- Contoh placeholder gambar -->
                    <!-- <img src="https://placehold.co/200x200/cccccc/333333?text=Foto+Siswa+1" alt="Foto Siswa 1" class="w-full h-48 object-cover rounded-lg shadow-md"> -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ðŸ”§ Konfigurasi Firebase (Disediakan oleh pengguna)
        const firebaseConfig = {
            apiKey: "AIzaSyDrt5MHhs-Wjoye8swLwLb068HC4kme-rg",
            authDomain: "absensionlinemuhika.firebaseapp.com",
            databaseURL: "https://absensionlinemuhika-default-rtdb.firebaseio.com",
            projectId: "absensionlinemuhika"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUserRole = null; // Menyimpan peran pengguna yang login
        let currentUserName = null; // Menyimpan nama pengguna yang login
        let currentUserClass = null; // Menyimpan kelas jika peran adalah wali kelas

        // Variabel global untuk peta Leaflet
        let map;
        let markers = [];

        // Fungsi inisialisasi peta OpenStreetMap (menggunakan Leaflet)
        function initMap() {
            // Lokasi default (misalnya, Purwakarta)
            const defaultLocation = { lat: -6.5583, lng: 107.4589 }; // Koordinat Purwakarta

            // Hapus peta yang sudah ada jika ada, untuk menghindari duplikasi
            if (map && map.remove) {
                map.remove();
            }

            // Inisialisasi peta Leaflet
            map = L.map('mapContainer').setView([defaultLocation.lat, defaultLocation.lng], 12);

            // Tambahkan layer tile OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            console.log('Peta OpenStreetMap (Leaflet) diinisialisasi.');
            // Kosongkan pesan "Memuat peta..." setelah peta siap
            document.querySelector('#mapContainer p.loading-message')?.remove();
        }


        // Pendengar Status Otentikasi Firebase
        auth.onAuthStateChanged(user => {
            if (user) {
                // Pengguna sudah login. Dapatkan perannya.
                db.ref('users/' + user.uid).once('value').then(snapshot => {
                    const userData = snapshot.val();
                    if (userData) {
                        currentUserRole = userData.role;
                        currentUserName = userData.name;
                        currentUserClass = userData.associatedClass || null; // Untuk wali kelas
                        showAdminPanel(user.email);
                        // Klik tab pertama secara default setelah login
                        document.querySelector('.tab-button.active')?.click();
                    } else {
                        // Pengguna ada di Auth tapi tidak ada data peran di DB, logout atau tetapkan peran default
                        document.getElementById("login-error").innerText = "Informasi peran pengguna tidak ditemukan. Silakan hubungi admin.";
                        logout();
                    }
                }).catch(error => {
                    console.error("Kesalahan saat mengambil peran pengguna:", error);
                    document.getElementById("login-error").innerText = "Gagal memuat peran pengguna. Coba lagi.";
                    logout();
                });
            } else {
                // Pengguna sudah logout.
                showLoginArea();
            }
        });

        // âœ… Fungsi Login
        async function login() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const loginError = document.getElementById("login-error");
            loginError.innerText = ""; // Hapus error sebelumnya

            try {
                await auth.signInWithEmailAndPassword(email, pass);
                // Pendengar status otentikasi akan menangani tampilan panel
            } catch (error) {
                console.error("Kesalahan Login:", error.code, error.message);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    loginError.innerText = "Email atau Kata Sandi salah.";
                } else if (error.code === 'auth/invalid-email') {
                    loginError.innerText = "Format email tidak valid.";
                } else {
                    loginError.innerText = "Terjadi kesalahan saat login: " + error.message;
                }
            }
        }

        // âœ… Fungsi Logout
        async function logout() {
            try {
                await auth.signOut();
                currentUserRole = null;
                currentUserName = null;
                currentUserClass = null;
                // Bersihkan marker peta jika peta ada
                markers.forEach(marker => marker.remove()); // Gunakan marker.remove() untuk Leaflet
                markers = [];
                // Pendengar status otentikasi akan menangani tampilan area login
            } catch (error) {
                console.error("Kesalahan Logout:", error);
                // Opsional tampilkan pesan jika logout gagal
            }
        }

        // --- Manajemen Status UI ---
        function showAdminPanel(userEmail) {
            document.getElementById("login-area").classList.add("hidden");
            document.getElementById("admin-panel").classList.remove("hidden");
            document.getElementById("loggedInUserInfo").innerText = `Login sebagai: ${currentUserName || userEmail} (${currentUserRole})`;
            document.getElementById("login-error").innerText = ""; // Hapus error yang tersisa
        }

        function showLoginArea() {
            document.getElementById("login-area").classList.remove("hidden");
            document.getElementById("admin-panel").classList.add("hidden");
            document.getElementById("guruAbsensiBody").innerHTML = "";
            document.getElementById("siswaAbsensiBody").innerHTML = "";
            document.getElementById('email').value = ''; // Bersihkan kolom input
            document.getElementById('password').value = '';
            document.getElementById("login-error").innerText = "";
        }

        // --- Navigasi Tab ---
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                document.querySelectorAll('.content-section').forEach(section => section.classList.add('hidden'));
                const targetSectionId = this.dataset.tab;
                document.getElementById(targetSectionId).classList.remove('hidden');

                // Muat data khusus untuk tab
                if (targetSectionId === 'guru-absensi-section') {
                    loadAbsensiData('guru', document.getElementById('filterGuruHari').value);
                } else if (targetSectionId === 'siswa-absensi-section') {
                    loadAbsensiData('siswa', document.getElementById('filterSiswaHari').value);
                } else if (targetSectionId === 'map-siswa-section') {
                    // Inisialisasi peta saat tab peta diaktifkan
                    // Pastikan peta diinisialisasi hanya sekali
                    if (!map) {
                        initMap();
                    }
                    loadSiswaLocations(); // Panggil fungsi untuk memuat lokasi siswa
                }
                // Bagian Galeri tidak memerlukan pemuatan data khusus untuk contoh ini,
                // tetapi Anda bisa menambahkan fungsi di sini jika diperlukan.
            });
        });

        // --- Fungsi Pemuatan Data ---

        /**
         * Mengambil dan menampilkan data absensi berdasarkan peran pengguna dan hari yang dipilih.
         * @param {string} type 'guru' atau 'siswa'
         * @param {string} filterDay 'all' atau '1' hingga '7'
         */
        async function loadAbsensiData(type, filterDay = 'all') {
            const tbodyId = type === 'guru' ? 'guruAbsensiBody' : 'siswaAbsensiBody';
            const tableId = type === 'guru' ? 'guruAbsensiTable' : 'siswaAbsensiTable';
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = `<tr><td colspan="9" class="loading-message">Memuat data absensi ${type === 'guru' ? 'guru' : 'siswa'}...</td></tr>`;

            try {
                let refPath = type === 'guru' ? 'absensi/guru' : 'absensi/siswa';
                const snapshot = await db.ref(refPath).once('value');
                const rawData = snapshot.val();
                let filteredData = [];

                if (rawData) {
                    // Agregasi data berdasarkan orang (guru/siswa) lalu berdasarkan tanggal
                    const aggregated = {};

                    if (type === 'guru') {
                        for (const guruId in rawData) {
                            if (currentUserRole === 'guru' && guruId !== auth.currentUser.uid) {
                                continue; // Guru hanya melihat datanya sendiri
                            }
                            const dailyEntries = rawData[guruId];
                            const guruNameFromDB = await getDisplayName(guruId, 'guru'); // Dapatkan nama guru dari profil pengguna
                            if (!aggregated[guruId]) {
                                aggregated[guruId] = {
                                    id: guruId,
                                    namaGuru: guruNameFromDB || 'Tidak Dikenal',
                                    pelajaran: 'Tidak Diketahui', // Akan ditentukan dari entri terbaru
                                    kelas: 'Tidak Diketahui', // Akan ditentukan dari entri terbaru
                                    lokasi: 'Tidak Diketahui',
                                    foto: 'Tidak Diketahui',
                                    materi: 'Tidak Diketahui',
                                    hari: {}, // Menyimpan status untuk setiap hari (misalnya, '2024-06-25': 'Hadir')
                                    dayStatuses: Array(7).fill('Belum Absen'), // Array untuk Hari 1 hingga Hari 7
                                    totalHadir: 0,
                                    totalAlfa: 0,
                                    totalIzin: 0,
                                    totalSakit: 0,
                                    totalMinggu: '0 Hari Hadir'
                                };
                            }
                            for (const date in dailyEntries) {
                                const entry = dailyEntries[date];
                                const dayOfWeek = new Date(date).getDay(); // 0 untuk Minggu, 1 untuk Senin...
                                const dayIndex = dayOfWeek === 0 ? 7 : dayOfWeek; // 1-7 untuk Sen-Ming

                                aggregated[guruId].hari[date] = entry.status;
                                aggregated[guruId].dayStatuses[dayIndex - 1] = entry.status; // Perbarui hari tertentu
                                // Ambil info terbaru untuk pelajaran, kelas, dll.
                                aggregated[guruId].pelajaran = entry.pelajaran || aggregated[guruId].pelajaran;
                                aggregated[guruId].kelas = entry.kelas || aggregated[guruId].kelas;
                                // Perbarui tautan peta untuk OpenStreetMap
                                aggregated[guruId].lokasi = entry.lokasi && entry.lokasi.latitude ? `<a href="https://www.openstreetmap.org/?mlat=${entry.lokasi.latitude}&mlon=${entry.lokasi.longitude}#map=15/${entry.lokasi.latitude}/${entry.lokasi.longitude}" target="_blank" class="text-blue-400 hover:underline">Lihat Peta</a>` : 'Tidak Ada';
                                aggregated[guruId].foto = entry.foto || aggregated[guruId].foto;
                                aggregated[guruId].materi = entry.materi || aggregated[guruId].materi;
                            }
                            // Hitung ringkasan mingguan
                            aggregated[guruId].totalHadir = aggregated[guruId].dayStatuses.filter(s => s === 'Hadir').length;
                            aggregated[guruId].totalAlfa = aggregated[guruId].dayStatuses.filter(s => s === 'Alfa').length;
                            aggregated[guruId].totalIzin = aggregated[guruId].dayStatuses.filter(s => s === 'Izin').length;
                            aggregated[guruId].totalSakit = aggregated[guruId].dayStatuses.filter(s => s === 'Sakit').length;
                            aggregated[guruId].totalMinggu = `${aggregated[guruId].totalHadir} Hadir, ${aggregated[guruId].totalSakit} Sakit, ${aggregated[guruId].totalIzin} Izin, ${aggregated[guruId].totalAlfa} Alfa`;
                            filteredData.push(aggregated[guruId]);
                        }
                    } else { // Pemrosesan data siswa (struktur mirip dengan logika data pengguna asli)
                        for (const userId in rawData) {
                             if (currentUserRole === 'guru' && !(await isTeacherOfStudent(userId, currentUserName))) {
                                continue; // Guru hanya melihat siswa yang dia ajar
                            }
                            if (currentUserRole === 'waliKelas' && !(await isStudentInWaliKelasClass(userId, currentUserClass))) {
                                continue; // Wali Kelas hanya melihat siswa di kelasnya
                            }

                            const mapelData = rawData[userId];
                            if (!aggregated[userId]) {
                                aggregated[userId] = {
                                    id: userId,
                                    namaSiswa: 'Tidak Dikenal', // Akan ditentukan
                                    pelajaran: 'Tidak Diketahui',
                                    kelas: 'Tidak Diketahui',
                                    lokasi: 'Tidak Diketahui',
                                    foto: 'Tidak Diketahui',
                                    namaGuru: 'Tidak Diketahui',
                                    hari: {}, // Menyimpan status untuk setiap hari (misalnya, '2024-06-25': 'Hadir')
                                    dayStatuses: Array(7).fill('Belum Absen'),
                                    totalHadir: 0,
                                    totalAlfa: 0,
                                    totalIzin: 0,
                                    totalSakit: 0,
                                    totalMinggu: '0 Hari Hadir'
                                };
                            }
                            // Iterasi melalui mapel lalu entri waktu
                            for (const mapelKey in mapelData) {
                                const waktuData = mapelData[mapelKey];
                                for (const waktuKey in waktuData) {
                                    const entry = waktuData[waktuKey];
                                    const date = new Date(entry.waktu).toISOString().split('T')[0]; // Format ISO 8601 YYYY-MM-DD
                                    const dayOfWeek = new Date(date).getDay();
                                    const dayIndex = dayOfWeek === 0 ? 7 : dayOfWeek;

                                    // Untuk kesederhanaan, ambil status entri terakhir untuk hari itu
                                    aggregated[userId].hari[date] = entry.status || 'Hadir'; // Asumsikan Hadir jika status hilang
                                    aggregated[userId].dayStatuses[dayIndex - 1] = entry.status || 'Hadir';

                                    aggregated[userId].namaSiswa = entry.nama || aggregated[userId].namaSiswa;
                                    aggregated[userId].pelajaran = entry.mapel || aggregated[userId].pelajaran;
                                    aggregated[userId].kelas = entry.kelas || aggregated[userId].kelas;
                                    aggregated[userId].namaGuru = entry.namaGuru || aggregated[userId].namaGuru;
                                    // Perbarui tautan peta untuk OpenStreetMap
                                    aggregated[userId].lokasi = entry.lokasi && entry.lokasi.latitude ? `<a href="https://www.openstreetmap.org/?mlat=${entry.lokasi.latitude}&mlon=${entry.lokasi.longitude}#map=15/${entry.lokasi.latitude}/${entry.lokasi.longitude}" target="_blank" class="text-blue-400 hover:underline">Lihat Peta</a>` : 'Tidak Ada';
                                    aggregated[userId].foto = entry.foto || aggregated[userId].foto;
                                }
                            }
                             // Hitung ringkasan mingguan
                            aggregated[userId].totalHadir = aggregated[userId].dayStatuses.filter(s => s === 'Hadir').length;
                            aggregated[userId].totalAlfa = aggregated[userId].dayStatuses.filter(s => s === 'Alfa').length;
                            aggregated[userId].totalIzin = aggregated[userId].dayStatuses.filter(s => s === 'Izin').length;
                            aggregated[userId].totalSakit = aggregated[userId].dayStatuses.filter(s => s === 'Sakit').length;
                            aggregated[userId].totalMinggu = `${aggregated[userId].totalHadir} Hadir, ${aggregated[userId].totalSakit} Sakit, ${aggregated[userId].totalIzin} Izin, ${aggregated[userId].totalAlfa} Alfa`;
                            filteredData.push(aggregated[userId]);
                        }
                    }
                }

                // Render tabel
                renderTable(type, filteredData, filterDay);
            } catch (error) {
                console.error("Kesalahan saat memuat data absensi:", error);
                tbody.innerHTML = `<tr><td colspan="9" class="error-message">Gagal memuat data. ${error.message}</td></tr>`;
            }
        }

        // Helper untuk mendapatkan nama tampilan dari node pengguna (asumsi ID pengguna adalah UID Firebase atau ID yang dikenal)
        async function getDisplayName(uid, type) {
            const userSnapshot = await db.ref(`users/${uid}`).once('value');
            const userData = userSnapshot.val();
            return userData ? userData.name : (type === 'guru' ? 'Guru Tidak Dikenal' : 'Siswa Tidak Dikenal');
        }

        // Helper untuk memeriksa apakah seorang siswa diajar oleh guru saat ini
        // (Logika ini perlu lebih kuat, mungkin array 'studentsTaught' di profil pengguna atau tabel pencarian)
        async function isTeacherOfStudent(studentId, teacherName) {
            // Untuk saat ini, pemeriksaan yang sangat dasar. Pada kenyataannya, Anda memerlukan struktur database yang lebih kuat
            // untuk menautkan siswa ke guru dan mata pelajaran.
            const studentAbsenceSnapshot = await db.ref(`absensi/siswa/${studentId}`).once('value');
            const studentData = studentAbsenceSnapshot.val();
            if (studentData) {
                 for (const mapelKey in studentData) {
                    const waktuData = studentData[mapelKey];
                    for (const waktuKey in waktuData) {
                        const entry = waktuData[waktuKey];
                        if (entry.namaGuru === teacherName) {
                            return true;
                        }
                    }
                 }
            }
            return false;
        }

        // Helper untuk memeriksa apakah seorang siswa berada di kelas wali kelas
        async function isStudentInWaliKelasClass(studentId, waliKelasClass) {
            // Mirip dengan isTeacherOfStudent, memerlukan struktur DB yang kuat
            const studentAbsenceSnapshot = await db.ref(`absensi/siswa/${studentId}`).once('value');
            const studentData = studentAbsenceSnapshot.val();
            if (studentData) {
                 for (const mapelKey in studentData) {
                    const waktuData = studentData[mapelKey];
                    for (const waktuKey in waktuData) {
                        const entry = waktuData[waktuKey];
                        if (entry.kelas === waliKelasClass) {
                            return true;
                        }
                    }
                 }
            }
            return false;
        }


        /**
         * Merender tabel dengan data absensi.
         * @param {string} type 'guru' atau 'siswa'
         * @param {Array} data Data absensi yang diagregasi.
         * @param {string} filterDay 'all' atau '1' hingga '7'
         */
        function renderTable(type, data, filterDay) {
            const tbodyId = type === 'guru' ? 'guruAbsensiBody' : 'siswaAbsensiBody';
            const tableId = type === 'guru' ? 'guruAbsensiTable' : 'siswaAbsensiTable';
            const tbody = document.getElementById(tbodyId);
            const theadRow = document.querySelector(`#${tableId} thead tr`);
            tbody.innerHTML = ''; // Bersihkan data yang ada

            // Sesuaikan header tabel secara dinamis untuk absensi harian
            // Hapus header dinamis sebelumnya (Hari 1-7) dan "Keseluruhan"
            theadRow.querySelectorAll('.dynamic-day-header, [data-column="totalMinggu"]').forEach(header => header.remove());

            if (filterDay === 'all') {
                // Tambahkan header Hari 1-7 jika "Keseluruhan" dipilih
                for (let i = 1; i <= 7; i++) {
                    const th = document.createElement('th');
                    th.textContent = `Hari ke-${i}`;
                    th.classList.add('dynamic-day-header');
                    th.setAttribute('data-column', `hari${i}`); // Tambahkan data-column untuk penyortiran
                    theadRow.insertBefore(th, theadRow.querySelector('[data-column="indikator"]'));
                }
                // Tambahkan header "Keseluruhan"
                const totalTh = document.createElement('th');
                totalTh.textContent = 'Keseluruhan (Minggu)';
                totalTh.setAttribute('data-column', 'totalMinggu');
                totalTh.classList.add('dynamic-day-header'); // Tandai sebagai dinamis
                theadRow.appendChild(totalTh); // Tambahkan setelah indikator
            } else {
                // Jika hari tertentu difilter, hanya tampilkan header hari itu
                const th = document.createElement('th');
                th.textContent = `Hari ke-${filterDay}`;
                th.classList.add('dynamic-day-header');
                th.setAttribute('data-column', `hari${filterDay}`);
                theadRow.insertBefore(th, theadRow.querySelector('[data-column="indikator"]'));
            }

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${theadRow.cells.length}" class="loading-message">Tidak ada data absensi untuk ditampilkan.</td></tr>`;
                return;
            }

            data.forEach(entry => {
                const row = tbody.insertRow();

                // Tambahkan sel data berdasarkan jenis
                if (type === 'guru') {
                    row.insertCell().setAttribute('data-label', 'Nama Guru'); row.cells[row.cells.length - 1].textContent = entry.namaGuru;
                    row.insertCell().setAttribute('data-label', 'Pelajaran'); row.cells[row.cells.length - 1].textContent = entry.pelajaran;
                    row.insertCell().setAttribute('data-label', 'Kelas'); row.cells[row.cells.length - 1].textContent = entry.kelas;

                    const lokasiCell = row.insertCell(); lokasiCell.setAttribute('data-label', 'Lokasi'); lokasiCell.innerHTML = entry.lokasi;
                    const fotoCell = row.insertCell(); fotoCell.setAttribute('data-label', 'Foto');
                    if (entry.foto && entry.foto !== 'Tidak Diketahui') {
                        const img = document.createElement('img');
                        img.src = entry.foto;
                        img.alt = 'Foto Guru';
                        fotoCell.appendChild(img);
                    } else {
                        fotoCell.textContent = 'Tidak Ada';
                    }
                    const materiCell = row.insertCell(); materiCell.setAttribute('data-label', 'Materi'); materiCell.textContent = entry.materi;

                    // Sembunyikan/Tampilkan kolom tertentu berdasarkan peran
                    if (currentUserRole !== 'kepalaSekolah' && currentUserRole !== 'wakasek') {
                        lokasiCell.classList.add('hidden');
                        fotoCell.classList.add('hidden');
                        materiCell.classList.add('hidden');
                    }

                } else { // type === 'siswa'
                    row.insertCell().setAttribute('data-label', 'Nama'); row.cells[row.cells.length - 1].textContent = entry.namaSiswa;
                    row.insertCell().setAttribute('data-label', 'Pelajaran'); row.cells[row.cells.length - 1].textContent = entry.pelajaran;
                    row.insertCell().setAttribute('data-label', 'Kelas'); row.cells[row.cells.length - 1].textContent = entry.kelas;

                    const lokasiCell = row.insertCell(); lokasiCell.setAttribute('data-label', 'Lokasi'); lokasiCell.innerHTML = entry.lokasi;
                    const fotoCell = row.insertCell(); fotoCell.setAttribute('data-label', 'Foto');
                    if (entry.foto && entry.foto !== 'Tidak Diketahui') {
                        const img = document.createElement('img');
                        img.src = entry.foto;
                        img.alt = 'Foto Siswa';
                        fotoCell.appendChild(img);
                    } else {
                        fotoCell.textContent = 'Tidak Ada';
                    }
                    const namaGuruCell = row.insertCell(); namaGuruCell.setAttribute('data-label', 'Nama Guru'); namaGuruCell.textContent = entry.namaGuru;

                    // Sembunyikan/Tampilkan kolom tertentu berdasarkan peran
                    if (currentUserRole !== 'kepalaSekolah' && currentUserRole !== 'wakasek') {
                        lokasiCell.classList.add('hidden');
                        fotoCell.classList.add('hidden');
                        namaGuruCell.classList.add('hidden');
                    }
                }

                // Tambahkan sel status harian
                if (filterDay === 'all') {
                    entry.dayStatuses.forEach((status, index) => {
                        const cell = row.insertCell();
                        cell.setAttribute('data-label', `Hari ke-${index + 1}`);
                        cell.textContent = status;
                        if (status === 'Alfa') cell.classList.add('indicator-red');
                        else if (status === 'Sakit' || status === 'Izin') cell.classList.add('indicator-yellow');
                        else if (status === 'Hadir') cell.classList.add('indicator-green');
                    });
                } else {
                    const dayIndex = parseInt(filterDay) - 1;
                    const cell = row.insertCell();
                    cell.setAttribute('data-label', `Hari ke-${filterDay}`);
                    const status = entry.dayStatuses[dayIndex];
                    cell.textContent = status;
                    if (status === 'Alfa') cell.classList.add('indicator-red');
                    else if (status === 'Sakit' || status === 'Izin') cell.classList.add('indicator-yellow');
                    else if (status === 'Hadir') cell.classList.add('indicator-green');
                }

                // Tambahkan Indikator
                const indicatorCell = row.insertCell();
                indicatorCell.setAttribute('data-label', 'Indikator');
                if (entry.totalAlfa > 0) {
                    indicatorCell.classList.add('indicator-red');
                    indicatorCell.textContent = 'Buruk';
                } else if (entry.totalSakit > 0 || entry.totalIzin > 0) {
                    indicatorCell.classList.add('indicator-yellow');
                    indicatorCell.textContent = 'Perhatian';
                } else {
                    indicatorCell.classList.add('indicator-green');
                    indicatorCell.textContent = 'Baik';
                }

                // Tambahkan Keseluruhan (Minggu)
                const totalMingguCell = row.insertCell();
                totalMingguCell.setAttribute('data-label', 'Keseluruhan (Minggu)');
                totalMingguCell.textContent = entry.totalMinggu;
            });
            attachSortingListeners(tableId); // Pasang kembali pendengar penyortiran setelah merender
        }


        // --- Penyaringan berdasarkan Hari ---
        document.getElementById('filterGuruHari').addEventListener('change', function() {
            loadAbsensiData('guru', this.value);
        });

        document.getElementById('filterSiswaHari').addEventListener('change', function() {
            loadAbsensiData('siswa', this.value);
        });

        // --- Penyortiran Tabel ---
        function attachSortingListeners(tableId) {
            const table = document.getElementById(tableId);
            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                // Hapus pendengar yang ada untuk mencegah duplikasi
                header.removeEventListener('click', header._sortHandler);
                header._sortHandler = () => sortTable(tableId, index);
                header.addEventListener('click', header._sortHandler);
            });
        }

        let currentSortColumn = -1;
        let currentSortDirection = 'asc';

        function sortTable(tableId, n) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.rows);
            const headers = table.querySelectorAll('th');

            // Setel ulang indikator penyortiran pada header lain
            headers.forEach(header => {
                header.classList.remove('asc', 'desc');
            });

            // Tentukan arah penyortiran
            if (currentSortColumn === n) {
                currentSortDirection = (currentSortDirection === 'asc') ? 'desc' : 'asc';
            } else {
                currentSortColumn = n;
                currentSortDirection = 'asc';
            }

            // Tambahkan indikator ke header saat ini
            headers[n].classList.add(currentSortDirection);

            rows.sort((rowA, rowB) => {
                let x = rowA.cells[n].textContent.toLowerCase();
                let y = rowB.cells[n].textContent.toLowerCase();

                // Tangani angka jika berlaku (misalnya, total hari)
                if (!isNaN(parseFloat(x)) && !isNaN(parseFloat(y))) {
                    x = parseFloat(x);
                    y = parseFloat(y);
                }

                let comparison = 0;
                if (x > y) {
                    comparison = 1;
                } else if (x < y) {
                    comparison = -1;
                }
                return currentSortDirection === 'asc' ? comparison : -comparison;
            });

            // Tambahkan kembali baris yang sudah diurutkan
            rows.forEach(row => tbody.appendChild(row));
        }

        // --- Fungsionalitas Ekspor ke Excel ---
        function exportTableToExcel(tableId, filename = '') {
            const table = document.getElementById(tableId);
            const ws = XLSX.utils.table_to_sheet(table);

            // Buat workbook baru dan tambahkan worksheet
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

            // Tetapkan nama file default jika tidak disediakan
            if (!filename) {
                filename = tableId + '.xlsx';
            }

            // Tulis workbook dan picu unduhan
            XLSX.writeFile(wb, filename);
        }

        document.getElementById('exportGuruExcel').addEventListener('click', function() {
            exportTableToExcel('guruAbsensiTable', 'Rekap_Absensi_Guru.xlsx');
        });

        document.getElementById('exportSiswaExcel').addEventListener('click', function() {
            exportTableToExcel('siswaAbsensiTable', 'Rekap_Absensi_Siswa.xlsx');
        });

        // --- Fungsi untuk memuat dan menampilkan lokasi siswa di peta ---
        async function loadSiswaLocations() {
            if (!map) {
                console.error("Peta belum diinisialisasi. Tidak dapat memuat lokasi siswa.");
                document.getElementById('mapContainer').innerHTML = '<p class="error-message text-red-500">Gagal memuat peta. Pastikan Leaflet dimuat dan koneksi internet stabil.</p>';
                return;
            }

            // Hapus semua marker yang ada sebelumnya
            markers.forEach(marker => marker.remove()); // Gunakan marker.remove() untuk Leaflet
            markers = [];

            // Tampilkan pesan loading di peta
            const mapContainer = document.getElementById('mapContainer');
            if (!mapContainer.querySelector('.loading-message')) {
                const loadingParagraph = document.createElement('p');
                loadingParagraph.classList.add('loading-message', 'text-gray-400', 'absolute', 'inset-0', 'flex', 'items-center', 'justify-center');
                loadingParagraph.textContent = 'Memuat lokasi siswa...';
                mapContainer.appendChild(loadingParagraph);
            }

            try {
                // Ambil data absensi siswa
                const snapshot = await db.ref('absensi/siswa').once('value');
                const rawData = snapshot.val();
                let bounds = L.latLngBounds(); // Gunakan L.latLngBounds() untuk Leaflet
                let locationsFound = false;

                if (rawData) {
                    for (const userId in rawData) {
                        const mapelData = rawData[userId];
                        for (const mapelKey in mapelData) {
                            const waktuData = mapelData[mapelKey];
                            for (const waktuKey in waktuData) {
                                const entry = waktuData[waktuKey];
                                if (entry.lokasi && entry.lokasi.latitude && entry.lokasi.longitude) {
                                    const lat = parseFloat(entry.lokasi.latitude);
                                    const lng = parseFloat(entry.lokasi.longitude);

                                    if (!isNaN(lat) && !isNaN(lng)) {
                                        const position = L.latLng(lat, lng); // Gunakan L.latLng untuk Leaflet
                                        const marker = L.marker(position).addTo(map); // Buat marker Leaflet

                                        // Tambahkan popup (info window)
                                        const infoWindowContent = `
                                            <div class="p-2 text-black">
                                                <h4 class="font-bold">${entry.nama || 'Siswa Tidak Dikenal'}</h4>
                                                <p>Kelas: ${entry.kelas || 'Tidak Diketahui'}</p>
                                                <p>Pelajaran: ${entry.mapel || 'Tidak Diketahui'}</p>
                                                <p>Waktu: ${new Date(entry.waktu).toLocaleString('id-ID')}</p>
                                                ${entry.foto ? `<img src="${entry.foto}" alt="Foto Siswa" style="width:100px; height:auto; border-radius:4px; margin-top:8px;">` : ''}
                                            </div>
                                        `;
                                        marker.bindPopup(infoWindowContent); // Ikat popup ke marker

                                        markers.push(marker);
                                        bounds.extend(position);
                                        locationsFound = true;
                                    }
                                }
                            }
                        }
                    }
                }

                // Hapus pesan loading
                mapContainer.querySelector('.loading-message')?.remove();

                if (locationsFound) {
                    map.fitBounds(bounds); // Zoom dan paskan peta ke semua marker
                } else {
                    // Jika tidak ada lokasi ditemukan, setel kembali ke lokasi default Purwakarta
                    map.setView({ lat: -6.5583, lng: 107.4589 }, 12); // Gunakan setView untuk Leaflet
                    if (!mapContainer.querySelector('.error-message')) {
                        const noDataParagraph = document.createElement('p');
                        noDataParagraph.classList.add('error-message', 'text-gray-400', 'absolute', 'inset-0', 'flex', 'items-center', 'justify-center');
                        noDataParagraph.textContent = 'Tidak ada data lokasi siswa yang tersedia.';
                        mapContainer.appendChild(noDataParagraph);
                    }
                }

            } catch (error) {
                console.error("Kesalahan saat memuat lokasi siswa untuk peta:", error);
                mapContainer.querySelector('.loading-message')?.remove();
                if (!mapContainer.querySelector('.error-message')) {
                    const errorParagraph = document.createElement('p');
                    errorParagraph.classList.add('error-message', 'text-red-500', 'absolute', 'inset-0', 'flex', 'items-center', 'justify-center');
                    errorParagraph.textContent = `Gagal memuat lokasi peta: ${error.message}.`;
                    mapContainer.appendChild(errorParagraph);
                }
            }
        }


        // Logika render awal setelah DOM siap dan status Otentikasi Firebase diketahui
        document.addEventListener('DOMContentLoaded', () => {
            // Tidak perlu memanggil showLoginArea() di sini; onAuthStateChanged menangani status awal
            // dan memanggil showAdminPanel() atau menjaga area login jika tidak terautentikasi.
            // Pastikan tab pertama aktif secara default
            // Ini akan dipanggil setelah Pendengar Status Otentikasi menyelesaikan pekerjaannya
            // document.querySelector('.tab-button').click(); // Simulasikan klik pada tab pertama
        });
    </script>
</body>
</html>
