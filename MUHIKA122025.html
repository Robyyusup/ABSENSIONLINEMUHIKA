<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Login Admin & Panel Absensi - SMK Muhammadiyah Campaka Purwakarta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS configuration for custom styles (optional, but good for consistency)
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4CAF50', // Green
                        secondary: '#333',
                        background: '#1a1a1a',
                        card: '#2a2a2a',
                        text: '#e0e0e0',
                        light_green: '#8BC34A',
                        light_red: '#FFCDD2',
                        light_yellow: '#FFF9C4',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: theme('colors.background');
            color: theme('colors.text');
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align items to the top for content */
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            background-color: theme('colors.card');
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            box-sizing: border-box;
        }
        h2 {
            text-align: center;
            color: theme('colors.primary');
            margin-bottom: 30px;
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700; /* font-bold */
        }
        .input-group {
            margin-bottom: 20px;
        }
        input, button {
            padding: 12px 15px;
            margin: 5px 0;
            border: 1px solid theme('colors.secondary');
            border-radius: 8px;
            font-size: 1rem;
            color: theme('colors.text');
            background-color: theme('colors.secondary');
            width: 100%;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        input:focus {
            border-color: theme('colors.primary');
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.5); /* primary-500 with alpha */
        }
        button {
            background: theme('colors.primary');
            color: white;
            cursor: pointer;
            border: none;
            font-weight: 600;
            margin-top: 15px;
        }
        button:hover {
            background-color: theme('colors.light_green');
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .hidden {
            display: none;
        }
        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .tab-button {
            background-color: theme('colors.secondary');
            color: theme('colors.text');
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border: 1px solid theme('colors.secondary');
        }
        .tab-button:hover {
            background-color: #555;
            border-color: #555;
        }
        .tab-button.active {
            background-color: theme('colors.primary');
            border-color: theme('colors.primary');
            color: white;
            box-shadow: 0 3px 10px rgba(76, 175, 80, 0.4);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: theme('colors.background');
            color: theme('colors.text');
            border-radius: 8px;
            overflow: hidden; /* For rounded corners on table */
        }
        th, td {
            padding: 12px;
            border: 1px solid #444; /* Darker border for contrast */
            text-align: left;
        }
        th {
            background-color: theme('colors.secondary');
            color: theme('colors.primary');
            font-weight: 700;
            cursor: pointer;
            position: relative;
        }
        th:hover {
            background-color: #555;
        }
        th.asc::after { content: ' "admin-panel-app"5B2'; /* Up arrow */ position: absolute; right: 8px; top: 50%; transform: translateY(-50%); }
        th.desc::after { content: ' "admin-panel-app"5BC'; /* Down arrow */ position: absolute; right: 8px; top: 50%; transform: translateY(-50%); }

        tbody tr:nth-child(even) {
            background-color: #333; /* Slightly different background for even rows */
        }
        tbody tr:hover {
            background-color: #444;
        }
        img {
            max-width: 80px;
            height: auto;
            border-radius: 8px;
            object-fit: cover;
            display: block; /* Ensures no extra space below image */
            margin: auto;
        }
        .error-message {
            color: #FF5252; /* Red */
            margin-top: 10px;
            text-align: center;
            font-weight: 600;
        }
        .loading-message {
            text-align: center;
            padding: 20px;
            color: theme('colors.primary');
        }
        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-controls label {
            font-weight: 600;
        }
        .filter-controls select {
            background-color: theme('colors.secondary');
            border: 1px solid #555;
            padding: 8px;
            border-radius: 8px;
            color: theme('colors.text');
            width: auto;
            min-width: 150px;
        }
        .export-button {
            background-color: #007BFF; /* Blue */
            margin-top: 0;
        }
        .export-button:hover {
            background-color: #0056b3;
        }
        .indicator-red { background-color: theme('colors.light_red'); color: #C62828; font-weight: 600; }
        .indicator-yellow { background-color: theme('colors.light_yellow'); color: #FFD600; font-weight: 600; }
        .indicator-green { background-color: theme('colors.light_green'); color: #388E3C; font-weight: 600; }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            h2 {
                font-size: 1.75rem; /* text-3xl */
            }
            .tab-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            .filter-controls select, .filter-controls button {
                width: 100%;
            }
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid #555;
                margin-bottom: 15px;
                border-radius: 8px;
                overflow: hidden;
            }
            td {
                border: none;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            td::before {
                content: attr(data-label);
                position: absolute;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: theme('colors.primary');
            }
        }
    </style>
    <!-- Firebase SDK (v9 compat for your provided structure) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container rounded-xl">
        <div id="login-area">
            <h2 class="text-primary">Login Admin</h2>
            <div class="input-group">
                <input type="email" id="email" placeholder="Email" class="rounded-lg">
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="Password" class="rounded-lg">
            </div>
            <button onclick="login()" class="rounded-lg">Login</button>
            <p id="login-error" class="error-message"></p>
        </div>

        <div id="admin-panel" class="hidden">
            <h2 class="text-primary text-center">PANEL ADMIN REKAP ABSENSI<br>SMK MUHAMMADIYAH CAMPAKA PURWAKARTA</h2>
            <p id="loggedInUserInfo" class="text-center text-lg mb-5"></p>
            <div class="flex justify-end mb-5">
                <button onclick="logout()" class="rounded-lg bg-red-600 hover:bg-red-700">Logout</button>
            </div>

            <div class="tab-buttons">
                <button class="tab-button active rounded-lg" data-tab="guru-absensi-section">Absensi Guru</button>
                <button class="tab-button rounded-lg" data-tab="siswa-absensi-section">Absensi Siswa</button>
                <button class="tab-button rounded-lg" data-tab="map-siswa-section">Peta Siswa</button>
                <button class="tab-button rounded-lg" data-tab="gallery-siswa-section">Galeri Siswa</button>
            </div>

            <!-- Absensi Guru Section -->
            <div id="guru-absensi-section" class="content-section">
                <h3 class="text-primary text-xl font-bold mb-4 border-b pb-2 border-gray-600">(GURU) - Rekap Absensi</h3>
                <div class="filter-controls">
                    <label for="filterGuruHari">Hari:</label>
                    <select id="filterGuruHari" class="rounded-lg">
                        <option value="all">Keseluruhan dalam seminggu</option>
                        <option value="1">Hari ke-1</option>
                        <option value="2">Hari ke-2</option>
                        <option value="3">Hari ke-3</option>
                        <option value="4">Hari ke-4</option>
                        <option value="5">Hari ke-5</option>
                        <option value="6">Hari ke-6</option>
                        <option value="7">Hari ke-7</option>
                    </select>
                    <button id="exportGuruExcel" class="export-button rounded-lg">Export ke Excel</button>
                </div>
                <div class="table-responsive">
                    <table id="guruAbsensiTable" class="rounded-lg">
                        <thead>
                            <tr>
                                <th data-column="namaGuru">Nama Guru</th>
                                <th data-column="pelajaran">Pelajaran</th>
                                <th data-column="kelas">Kelas</th>
                                <th data-column="lokasi" class="guru-col-specific">Lokasi</th>
                                <th data-column="foto" class="guru-col-specific">Foto</th>
                                <th data-column="materi" class="guru-col-specific">Materi</th>
                                <!-- Dynamic daily headers will be inserted here -->
                                <th data-column="indikator">Indikator</th>
                                <th data-column="totalMinggu">Keseluruhan (Minggu)</th>
                            </tr>
                        </thead>
                        <tbody id="guruAbsensiBody">
                            <tr><td colspan="9" class="loading-message">Memuat data absensi guru...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Absensi Siswa Section -->
            <div id="siswa-absensi-section" class="content-section hidden">
                <h3 class="text-primary text-xl font-bold mb-4 border-b pb-2 border-gray-600">(SISWA) - Rekap Absensi</h3>
                <div class="filter-controls">
                    <label for="filterSiswaHari">Hari:</label>
                    <select id="filterSiswaHari" class="rounded-lg">
                        <option value="all">Keseluruhan dalam seminggu</option>
                        <option value="1">Hari ke-1</option>
                        <option value="2">Hari ke-2</option>
                        <option value="3">Hari ke-3</option>
                        <option value="4">Hari ke-4</option>
                        <option value="5">Hari ke-5</option>
                        <option value="6">Hari ke-6</option>
                        <option value="7">Hari ke-7</option>
                    </select>
                    <button id="exportSiswaExcel" class="export-button rounded-lg">Export ke Excel</button>
                </div>
                <div class="table-responsive">
                    <table id="siswaAbsensiTable" class="rounded-lg">
                        <thead>
                            <tr>
                                <th data-column="namaSiswa">Nama</th>
                                <th data-column="pelajaran">Pelajaran</th>
                                <th data-column="kelas">Kelas</th>
                                <th data-column="lokasi" class="siswa-col-specific">Lokasi</th>
                                <th data-column="foto" class="siswa-col-specific">Foto</th>
                                <th data-column="namaGuru" class="siswa-col-specific">Nama Guru</th>
                                <!-- Dynamic daily headers will be inserted here -->
                                <th data-column="indikator">Indikator</th>
                                <th data-column="totalMinggu">Keseluruhan (Minggu)</th>
                            </tr>
                        </thead>
                        <tbody id="siswaAbsensiBody">
                            <tr><td colspan="9" class="loading-message">Memuat data absensi siswa...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Peta Siswa Section -->
            <div id="map-siswa-section" class="content-section hidden">
                <h3 class="text-primary text-xl font-bold mb-4 border-b pb-2 border-gray-600">Tampilan Peta Siswa</h3>
                <div id="mapContainer" class="w-full h-96 bg-gray-700 rounded-lg flex items-center justify-center text-xl text-gray-400">
                    <p>Integrasi peta akan ditampilkan di sini. Anda dapat menggunakan Google Maps API atau OpenStreetMap.</p>
                    <p>Contoh: <a href="https://maps.google.com/maps?q=-6.2,107.2" target="_blank" class="text-blue-400 hover:underline">Lihat Contoh Lokasi</a></p>
                </div>
            </div>

            <!-- Galeri Siswa Section -->
            <div id="gallery-siswa-section" class="content-section hidden">
                <h3 class="text-primary text-xl font-bold mb-4 border-b pb-2 border-gray-600">Galeri Siswa</h3>
                <div id="galleryContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <p class="col-span-full text-center text-gray-400">Gambar galeri siswa akan ditampilkan di sini.</p>
                    <!-- Example image placeholder -->
                    <!-- <img src="https://placehold.co/200x200/cccccc/333333?text=Foto+Siswa+1" alt="Foto Siswa 1" class="w-full h-48 object-cover rounded-lg shadow-md"> -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 🔧 Firebase Config (Provided by user)
        const firebaseConfig = {
            apiKey: "AIzaSyDrt5MHhs-Wjoye8swLwLb068HC4kme-rg",
            authDomain: "absensionlinemuhika.firebaseapp.com",
            databaseURL: "https://absensionlinemuhika-default-rtdb.firebaseio.com",
            projectId: "absensionlinemuhika"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUserRole = null; // Store the role of the logged-in user
        let currentUserName = null; // Store the name of the logged-in user
        let currentUserClass = null; // Store the class if a wali kelas

        // Firebase Auth State Listener
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in. Get their role.
                db.ref('users/' + user.uid).once('value').then(snapshot => {
                    const userData = snapshot.val();
                    if (userData) {
                        currentUserRole = userData.role;
                        currentUserName = userData.name;
                        currentUserClass = userData.associatedClass || null; // For wali kelas
                        showAdminPanel(user.email);
                        loadAbsensiData('guru'); // Load default tab data
                    } else {
                        // User exists in Auth but no role data in DB, logout or assign default role
                        document.getElementById("login-error").innerText = "Informasi peran pengguna tidak ditemukan. Silakan hubungi admin.";
                        logout();
                    }
                }).catch(error => {
                    console.error("Error fetching user role:", error);
                    document.getElementById("login-error").innerText = "Gagal memuat peran pengguna. Coba lagi.";
                    logout();
                });
            } else {
                // User is signed out.
                showLoginArea();
            }
        });

        // ✅ Login Function
        async function login() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const loginError = document.getElementById("login-error");
            loginError.innerText = ""; // Clear previous errors

            try {
                await auth.signInWithEmailAndPassword(email, pass);
                // Auth state listener will handle showing the panel
            } catch (error) {
                console.error("Login Error:", error.code, error.message);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    loginError.innerText = "Email atau Password salah.";
                } else if (error.code === 'auth/invalid-email') {
                    loginError.innerText = "Format email tidak valid.";
                } else {
                    loginError.innerText = "Terjadi kesalahan saat login: " + error.message;
                }
            }
        }

        // ✅ Logout Function
        async function logout() {
            try {
                await auth.signOut();
                currentUserRole = null;
                currentUserName = null;
                currentUserClass = null;
                // Auth state listener will handle showing login area
            } catch (error) {
                console.error("Logout Error:", error);
                // Optionally show a message if logout fails
            }
        }

        // --- UI State Management ---
        function showAdminPanel(userEmail) {
            document.getElementById("login-area").classList.add("hidden");
            document.getElementById("admin-panel").classList.remove("hidden");
            document.getElementById("loggedInUserInfo").innerText = `Login sebagai: ${currentUserName || userEmail} (${currentUserRole})`;
            document.getElementById("login-error").innerText = ""; // Clear any lingering error
        }

        function showLoginArea() {
            document.getElementById("login-area").classList.remove("hidden");
            document.getElementById("admin-panel").classList.add("hidden");
            document.getElementById("guruAbsensiBody").innerHTML = "";
            document.getElementById("siswaAbsensiBody").innerHTML = "";
            document.getElementById('email').value = ''; // Clear input fields
            document.getElementById('password').value = '';
            document.getElementById("login-error").innerText = "";
        }

        // --- Tab Navigation ---
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                document.querySelectorAll('.content-section').forEach(section => section.classList.add('hidden'));
                const targetSectionId = this.dataset.tab;
                document.getElementById(targetSectionId).classList.remove('hidden');

                // Load data specific to the tab
                if (targetSectionId === 'guru-absensi-section') {
                    loadAbsensiData('guru', document.getElementById('filterGuruHari').value);
                } else if (targetSectionId === 'siswa-absensi-section') {
                    loadAbsensiData('siswa', document.getElementById('filterSiswaHari').value);
                }
                // Map and Gallery sections don't require specific data loading for this example,
                // but you would add functions here if they did.
            });
        });

        // --- Data Loading Functions ---

        /**
         * Fetches and displays attendance data based on user role and selected day.
         * @param {string} type 'guru' or 'siswa'
         * @param {string} filterDay 'all' or '1' through '7'
         */
        async function loadAbsensiData(type, filterDay = 'all') {
            const tbodyId = type === 'guru' ? 'guruAbsensiBody' : 'siswaAbsensiBody';
            const tableId = type === 'guru' ? 'guruAbsensiTable' : 'siswaAbsensiTable';
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = `<tr><td colspan="9" class="loading-message">Memuat data absensi ${type === 'guru' ? 'guru' : 'siswa'}...</td></tr>`;

            try {
                let refPath = type === 'guru' ? 'absensi/guru' : 'absensi/siswa';
                const snapshot = await db.ref(refPath).once('value');
                const rawData = snapshot.val();
                let filteredData = [];

                if (rawData) {
                    // Aggregate data by person (guru/siswa) and then by date
                    const aggregated = {};

                    if (type === 'guru') {
                        for (const guruId in rawData) {
                            if (currentUserRole === 'guru' && guruId !== auth.currentUser.uid) {
                                continue; // Guru only sees their own data
                            }
                            const dailyEntries = rawData[guruId];
                            const guruNameFromDB = await getDisplayName(guruId, 'guru'); // Get guru name from user profiles
                            if (!aggregated[guruId]) {
                                aggregated[guruId] = {
                                    id: guruId,
                                    namaGuru: guruNameFromDB || 'N/A',
                                    pelajaran: 'N/A', // Will be determined from latest entry
                                    kelas: 'N/A', // Will be determined from latest entry
                                    lokasi: 'N/A',
                                    foto: 'N/A',
                                    materi: 'N/A',
                                    hari: {}, // Stores status for each day (e.g., '2024-06-25': 'Hadir')
                                    dayStatuses: Array(7).fill('Belum Absen'), // Array for Day 1 to Day 7
                                    totalHadir: 0,
                                    totalAlfa: 0,
                                    totalIzin: 0,
                                    totalSakit: 0,
                                    totalMinggu: '0 Hari Hadir'
                                };
                            }
                            for (const date in dailyEntries) {
                                const entry = dailyEntries[date];
                                const dayOfWeek = new Date(date).getDay(); // 0 for Sunday, 1 for Monday...
                                const dayIndex = dayOfWeek === 0 ? 7 : dayOfWeek; // 1-7 for Mon-Sun

                                aggregated[guruId].hari[date] = entry.status;
                                aggregated[guruId].dayStatuses[dayIndex - 1] = entry.status; // Update specific day
                                // Take latest info for pelajaran, kelas, etc.
                                aggregated[guruId].pelajaran = entry.pelajaran || aggregated[guruId].pelajaran;
                                aggregated[guruId].kelas = entry.kelas || aggregated[guruId].kelas;
                                aggregated[guruId].lokasi = entry.lokasi ? `<a href="https://maps.google.com/maps?q=${entry.lokasi.latitude},${entry.lokasi.longitude}" target="_blank" class="text-blue-400 hover:underline">Lihat Peta</a>` : 'Tidak Ada';
                                aggregated[guruId].foto = entry.foto || aggregated[guruId].foto;
                                aggregated[guruId].materi = entry.materi || aggregated[guruId].materi;
                            }
                            // Calculate weekly summary
                            aggregated[guruId].totalHadir = aggregated[guruId].dayStatuses.filter(s => s === 'Hadir').length;
                            aggregated[guruId].totalAlfa = aggregated[guruId].dayStatuses.filter(s => s === 'Alfa').length;
                            aggregated[guruId].totalIzin = aggregated[guruId].dayStatuses.filter(s => s === 'Izin').length;
                            aggregated[guruId].totalSakit = aggregated[guruId].dayStatuses.filter(s => s === 'Sakit').length;
                            aggregated[guruId].totalMinggu = `${aggregated[guruId].totalHadir} Hadir, ${aggregated[guruId].totalSakit} Sakit, ${aggregated[guruId].totalIzin} Izin, ${aggregated[guruId].totalAlfa} Alfa`;
                            filteredData.push(aggregated[guruId]);
                        }
                    } else { // Siswa data processing (similar structure to original user data logic)
                        for (const userId in rawData) {
                             if (currentUserRole === 'guru' && !isTeacherOfStudent(userId, currentUserName)) {
                                continue; // Guru only sees students they teach
                            }
                            if (currentUserRole === 'waliKelas' && !(await isStudentInWaliKelasClass(userId, currentUserClass))) {
                                continue; // Wali Kelas only sees students in their class
                            }

                            const mapelData = rawData[userId];
                            if (!aggregated[userId]) {
                                aggregated[userId] = {
                                    id: userId,
                                    namaSiswa: 'N/A', // Will be determined
                                    pelajaran: 'N/A',
                                    kelas: 'N/A',
                                    lokasi: 'N/A',
                                    foto: 'N/A',
                                    namaGuru: 'N/A',
                                    hari: {}, // Stores status for each day (e.g., '2024-06-25': 'Hadir')
                                    dayStatuses: Array(7).fill('Belum Absen'),
                                    totalHadir: 0,
                                    totalAlfa: 0,
                                    totalIzin: 0,
                                    totalSakit: 0,
                                    totalMinggu: '0 Hari Hadir'
                                };
                            }
                            // Iterate through mapel and then time entries
                            for (const mapelKey in mapelData) {
                                const waktuData = mapelData[mapelKey];
                                for (const waktuKey in waktuData) {
                                    const entry = waktuData[waktuKey];
                                    const date = new Date(entry.waktu).toISOString().split('T')[0]; // YYYY-MM-DD format
                                    const dayOfWeek = new Date(date).getDay();
                                    const dayIndex = dayOfWeek === 0 ? 7 : dayOfWeek;

                                    // For simplicity, take the last entry's status for the day
                                    aggregated[userId].hari[date] = entry.status || 'Hadir'; // Assume Hadir if status missing
                                    aggregated[userId].dayStatuses[dayIndex - 1] = entry.status || 'Hadir';

                                    aggregated[userId].namaSiswa = entry.nama || aggregated[userId].namaSiswa;
                                    aggregated[userId].pelajaran = entry.mapel || aggregated[userId].pelajaran;
                                    aggregated[userId].kelas = entry.kelas || aggregated[userId].kelas;
                                    aggregated[userId].namaGuru = entry.namaGuru || aggregated[userId].namaGuru;
                                    aggregated[userId].lokasi = entry.lokasi && entry.lokasi.latitude ? `<a href="https://maps.google.com/maps?q=${entry.lokasi.latitude},${entry.lokasi.longitude}" target="_blank" class="text-blue-400 hover:underline">Lihat Peta</a>` : 'Tidak Ada';
                                    aggregated[userId].foto = entry.foto || aggregated[userId].foto;
                                }
                            }
                             // Calculate weekly summary
                            aggregated[userId].totalHadir = aggregated[userId].dayStatuses.filter(s => s === 'Hadir').length;
                            aggregated[userId].totalAlfa = aggregated[userId].dayStatuses.filter(s => s === 'Alfa').length;
                            aggregated[userId].totalIzin = aggregated[userId].dayStatuses.filter(s => s === 'Izin').length;
                            aggregated[userId].totalSakit = aggregated[userId].dayStatuses.filter(s => s === 'Sakit').length;
                            aggregated[userId].totalMinggu = `${aggregated[userId].totalHadir} Hadir, ${aggregated[userId].totalSakit} Sakit, ${aggregated[userId].totalIzin} Izin, ${aggregated[userId].totalAlfa} Alfa`;
                            filteredData.push(aggregated[userId]);
                        }
                    }
                }

                // Render table
                renderTable(type, filteredData, filterDay);
            } catch (error) {
                console.error("Error loading absensi data:", error);
                tbody.innerHTML = `<tr><td colspan="9" class="error-message">Gagal memuat data. ${error.message}</td></tr>`;
            }
        }

        // Helper to get display name from users node (assuming user IDs are Firebase UIDs or known IDs)
        async function getDisplayName(uid, type) {
            const userSnapshot = await db.ref(`users/${uid}`).once('value');
            const userData = userSnapshot.val();
            return userData ? userData.name : (type === 'guru' ? 'Guru Tidak Dikenal' : 'Siswa Tidak Dikenal');
        }

        // Helper to check if a student is taught by the current teacher
        // (This logic needs to be robust, perhaps a 'studentsTaught' array in user profile or a lookup table)
        async function isTeacherOfStudent(studentId, teacherName) {
            // For now, a very basic check. In reality, you'd need a more robust database structure
            // to link students to teachers and subjects.
            const studentAbsenceSnapshot = await db.ref(`absensi/siswa/${studentId}`).once('value');
            const studentData = studentAbsenceSnapshot.val();
            if (studentData) {
                 for (const mapelKey in studentData) {
                    const waktuData = studentData[mapelKey];
                    for (const waktuKey in waktuData) {
                        const entry = waktuData[waktuKey];
                        if (entry.namaGuru === teacherName) {
                            return true;
                        }
                    }
                 }
            }
            return false;
        }

        // Helper to check if a student is in the wali kelas's class
        async function isStudentInWaliKelasClass(studentId, waliKelasClass) {
            // Similar to isTeacherOfStudent, needs robust DB structure
            const studentAbsenceSnapshot = await db.ref(`absensi/siswa/${studentId}`).once('value');
            const studentData = studentAbsenceSnapshot.val();
            if (studentData) {
                 for (const mapelKey in studentData) {
                    const waktuData = studentData[mapelKey];
                    for (const waktuKey in waktuData) {
                        const entry = waktuData[waktuKey];
                        if (entry.kelas === waliKelasClass) {
                            return true;
                        }
                    }
                 }
            }
            return false;
        }


        /**
         * Renders the table with attendance data.
         * @param {string} type 'guru' or 'siswa'
         * @param {Array} data Aggregated attendance data.
         * @param {string} filterDay 'all' or '1' through '7'
         */
        function renderTable(type, data, filterDay) {
            const tbodyId = type === 'guru' ? 'guruAbsensiBody' : 'siswaAbsensiBody';
            const tableId = type === 'guru' ? 'guruAbsensiTable' : 'siswaAbsensiTable';
            const tbody = document.getElementById(tbodyId);
            const theadRow = document.querySelector(`#${tableId} thead tr`);
            tbody.innerHTML = ''; // Clear existing data

            // Dynamically adjust table headers for daily attendance
            // Remove previous dynamic headers (Day 1-7) and "Keseluruhan"
            theadRow.querySelectorAll('.dynamic-day-header, [data-column="totalMinggu"]').forEach(header => header.remove());

            if (filterDay === 'all') {
                // Add Day 1-7 headers if "Keseluruhan" is selected
                for (let i = 1; i <= 7; i++) {
                    const th = document.createElement('th');
                    th.textContent = `Hari ke-${i}`;
                    th.classList.add('dynamic-day-header');
                    th.setAttribute('data-column', `hari${i}`); // Add data-column for sorting
                    theadRow.insertBefore(th, theadRow.querySelector('[data-column="indikator"]'));
                }
                // Add "Keseluruhan" header
                const totalTh = document.createElement('th');
                totalTh.textContent = 'Keseluruhan (Minggu)';
                totalTh.setAttribute('data-column', 'totalMinggu');
                totalTh.classList.add('dynamic-day-header'); // Mark as dynamic
                theadRow.appendChild(totalTh); // Append after indicator
            } else {
                // If a specific day is filtered, only show that day's header
                const th = document.createElement('th');
                th.textContent = `Hari ke-${filterDay}`;
                th.classList.add('dynamic-day-header');
                th.setAttribute('data-column', `hari${filterDay}`);
                theadRow.insertBefore(th, theadRow.querySelector('[data-column="indikator"]'));
            }

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${theadRow.cells.length}" class="loading-message">Tidak ada data absensi untuk ditampilkan.</td></tr>`;
                return;
            }

            data.forEach(entry => {
                const row = tbody.insertRow();

                // Add data cells based on type
                if (type === 'guru') {
                    row.insertCell().setAttribute('data-label', 'Nama Guru'); row.cells[row.cells.length - 1].textContent = entry.namaGuru;
                    row.insertCell().setAttribute('data-label', 'Pelajaran'); row.cells[row.cells.length - 1].textContent = entry.pelajaran;
                    row.insertCell().setAttribute('data-label', 'Kelas'); row.cells[row.cells.length - 1].textContent = entry.kelas;

                    const lokasiCell = row.insertCell(); lokasiCell.setAttribute('data-label', 'Lokasi'); lokasiCell.innerHTML = entry.lokasi;
                    const fotoCell = row.insertCell(); fotoCell.setAttribute('data-label', 'Foto');
                    if (entry.foto && entry.foto !== 'N/A') {
                        const img = document.createElement('img');
                        img.src = entry.foto;
                        img.alt = 'Foto Guru';
                        fotoCell.appendChild(img);
                    } else {
                        fotoCell.textContent = 'Tidak Ada';
                    }
                    const materiCell = row.insertCell(); materiCell.setAttribute('data-label', 'Materi'); materiCell.textContent = entry.materi;

                    // Hide/Show specific columns based on role
                    if (currentUserRole !== 'kepalaSekolah' && currentUserRole !== 'wakasek') {
                        lokasiCell.classList.add('hidden');
                        fotoCell.classList.add('hidden');
                        materiCell.classList.add('hidden');
                    }

                } else { // type === 'siswa'
                    row.insertCell().setAttribute('data-label', 'Nama'); row.cells[row.cells.length - 1].textContent = entry.namaSiswa;
                    row.insertCell().setAttribute('data-label', 'Pelajaran'); row.cells[row.cells.length - 1].textContent = entry.pelajaran;
                    row.insertCell().setAttribute('data-label', 'Kelas'); row.cells[row.cells.length - 1].textContent = entry.kelas;

                    const lokasiCell = row.insertCell(); lokasiCell.setAttribute('data-label', 'Lokasi'); lokasiCell.innerHTML = entry.lokasi;
                    const fotoCell = row.insertCell(); fotoCell.setAttribute('data-label', 'Foto');
                    if (entry.foto && entry.foto !== 'N/A') {
                        const img = document.createElement('img');
                        img.src = entry.foto;
                        img.alt = 'Foto Siswa';
                        fotoCell.appendChild(img);
                    } else {
                        fotoCell.textContent = 'Tidak Ada';
                    }
                    const namaGuruCell = row.insertCell(); namaGuruCell.setAttribute('data-label', 'Nama Guru'); namaGuruCell.textContent = entry.namaGuru;

                    // Hide/Show specific columns based on role
                    if (currentUserRole !== 'kepalaSekolah' && currentUserRole !== 'wakasek') {
                        lokasiCell.classList.add('hidden');
                        fotoCell.classList.add('hidden');
                        namaGuruCell.classList.add('hidden');
                    }
                }

                // Add daily status cells
                if (filterDay === 'all') {
                    entry.dayStatuses.forEach((status, index) => {
                        const cell = row.insertCell();
                        cell.setAttribute('data-label', `Hari ke-${index + 1}`);
                        cell.textContent = status;
                        if (status === 'Alfa') cell.classList.add('indicator-red');
                        else if (status === 'Sakit' || status === 'Izin') cell.classList.add('indicator-yellow');
                        else if (status === 'Hadir') cell.classList.add('indicator-green');
                    });
                } else {
                    const dayIndex = parseInt(filterDay) - 1;
                    const cell = row.insertCell();
                    cell.setAttribute('data-label', `Hari ke-${filterDay}`);
                    const status = entry.dayStatuses[dayIndex];
                    cell.textContent = status;
                    if (status === 'Alfa') cell.classList.add('indicator-red');
                    else if (status === 'Sakit' || status === 'Izin') cell.classList.add('indicator-yellow');
                    else if (status === 'Hadir') cell.classList.add('indicator-green');
                }

                // Add Indikator
                const indicatorCell = row.insertCell();
                indicatorCell.setAttribute('data-label', 'Indikator');
                if (entry.totalAlfa > 0) {
                    indicatorCell.classList.add('indicator-red');
                    indicatorCell.textContent = 'Buruk';
                } else if (entry.totalSakit > 0 || entry.totalIzin > 0) {
                    indicatorCell.classList.add('indicator-yellow');
                    indicatorCell.textContent = 'Perhatian';
                } else {
                    indicatorCell.classList.add('indicator-green');
                    indicatorCell.textContent = 'Baik';
                }

                // Add Keseluruhan (Minggu)
                const totalMingguCell = row.insertCell();
                totalMingguCell.setAttribute('data-label', 'Keseluruhan (Minggu)');
                totalMingguCell.textContent = entry.totalMinggu;
            });
            attachSortingListeners(tableId); // Re-attach sorting after rendering
        }


        // --- Filtering by Day ---
        document.getElementById('filterGuruHari').addEventListener('change', function() {
            loadAbsensiData('guru', this.value);
        });

        document.getElementById('filterSiswaHari').addEventListener('change', function() {
            loadAbsensiData('siswa', this.value);
        });

        // --- Table Sorting ---
        function attachSortingListeners(tableId) {
            const table = document.getElementById(tableId);
            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                // Remove existing listeners to prevent duplicates
                header.removeEventListener('click', header._sortHandler);
                header._sortHandler = () => sortTable(tableId, index);
                header.addEventListener('click', header._sortHandler);
            });
        }

        let currentSortColumn = -1;
        let currentSortDirection = 'asc';

        function sortTable(tableId, n) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.rows);
            const headers = table.querySelectorAll('th');

            // Reset sort indicators on other headers
            headers.forEach(header => {
                header.classList.remove('asc', 'desc');
            });

            // Determine sort direction
            if (currentSortColumn === n) {
                currentSortDirection = (currentSortDirection === 'asc') ? 'desc' : 'asc';
            } else {
                currentSortColumn = n;
                currentSortDirection = 'asc';
            }

            // Add indicator to current header
            headers[n].classList.add(currentSortDirection);

            rows.sort((rowA, rowB) => {
                let x = rowA.cells[n].textContent.toLowerCase();
                let y = rowB.cells[n].textContent.toLowerCase();

                // Handle numbers if applicable (e.g., total days)
                if (!isNaN(parseFloat(x)) && !isNaN(parseFloat(y))) {
                    x = parseFloat(x);
                    y = parseFloat(y);
                }

                let comparison = 0;
                if (x > y) {
                    comparison = 1;
                } else if (x < y) {
                    comparison = -1;
                }
                return currentSortDirection === 'asc' ? comparison : -comparison;
            });

            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }

        // --- Export to Excel Functionality ---
        function exportTableToExcel(tableId, filename = '') {
            const table = document.getElementById(tableId);
            const ws = XLSX.utils.table_to_sheet(table);

            // Create a new workbook and add the worksheet
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

            // Set default filename if not provided
            if (!filename) {
                filename = tableId + '.xlsx';
            }

            // Write the workbook and trigger download
            XLSX.writeFile(wb, filename);
        }

        document.getElementById('exportGuruExcel').addEventListener('click', function() {
            exportTableToExcel('guruAbsensiTable', 'Rekap_Absensi_Guru.xlsx');
        });

        document.getElementById('exportSiswaExcel').addEventListener('click', function() {
            exportTableToExcel('siswaAbsensiTable', 'Rekap_Absensi_Siswa.xlsx');
        });

        // Initial render logic after DOM is ready and Firebase Auth state is known
        document.addEventListener('DOMContentLoaded', () => {
            // No need to call showLoginArea() here; onAuthStateChanged handles initial state
            // and calls showAdminPanel() or keeps login area if not authenticated.
            // Ensure first tab is active by default
            document.querySelector('.tab-button').click(); // Simulate click on first tab
        });
    </script>
</body>
</html>
